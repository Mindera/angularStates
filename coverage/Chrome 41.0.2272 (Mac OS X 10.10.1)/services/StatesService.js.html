<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for services/StatesService.js</title>
    <meta charset="utf-8">

    <link rel="stylesheet" href="../prettify.css">

    <link rel="stylesheet" href="../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header medium">
    <h1>Code coverage report for <span class="entity">services/StatesService.js</span></h1>
    <h2>
        
        Statements: <span class="metric">58.18% <small>(32 / 55)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">53.33% <small>(8 / 15)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">69.23% <small>(9 / 13)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">56.6% <small>(30 / 53)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../index.html">All files</a> &#187; <a href="index.html">services/</a> &#187; StatesService.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict';
&nbsp;
angular.module('angularStates')
.factory('StatesService', ['$window', '$rootElement', function ($window, $rootElement) {
    // TODO: Some stuff to implement in the future:
    // - expiration time for each object saved
    // - adapters so that it uses cookies/indexDB for example
    // - reset state method
&nbsp;
    var service = {
        namespace: $rootElement.attr('ng-app') ? <span class="branch-0 cbranch-no" title="branch not covered" >$rootElement.attr('ng-app') + '.' </span>: '',
        mapping: {},
&nbsp;
        /**
         * Registers a service instance on the persistence service
         * @param {Object} serviceInstance registered service instance - for updating its state afterwards
         * @param {String} keyName key used for mapping items the each service
         * @param {Array}  fields service properties that should be saved. Note: the elements of this array
         * can be strings (name of the field) or objects (containing default value to use in case of absence
         * in the persistence layer, and expiration time)
         * @throws {Error} will throw if the current keyName is already in use  
         **/
        register: function(serviceInstance, keyName, fields) {
            <span class="missing-if-branch" title="if path not taken" >I</span>if (service.mapping[keyName] !== undefined) {
<span class="cstat-no" title="statement not covered" >                throw new Error('keyName "' + keyName + '" already in use.'); </span>
            }
            service.mapping[keyName] = {
                instance: serviceInstance,
                data: {}
            };
&nbsp;
            fields.map(function(field) {
                var type = typeof field;
                switch (type) {
                    case 'object' : handleObject(keyName, field); break;
                    case 'string' : handleString(keyName, field); break;
<span class="branch-2 cbranch-no" title="branch not covered" >                    default: <span class="cstat-no" title="statement not covered" >break;</span></span>
                }
            });
        },
&nbsp;
        /**
         * Save the service state, based on the values mapped for the keyName provided
         * @param {String} keyName key used for mapping items to the service
         **/
        saveState: <span class="fstat-no" title="function not covered" >function(keyName) {</span>
<span class="cstat-no" title="statement not covered" >            var serviceInstance = service.mapping[keyName].instance;</span>
<span class="cstat-no" title="statement not covered" >            var currentVal;</span>
<span class="cstat-no" title="statement not covered" >            var currentValStr;</span>
            // Save each object for that keyname
<span class="cstat-no" title="statement not covered" >            var data = service.mapping[keyName].data;</span>
<span class="cstat-no" title="statement not covered" >            Object.keys(data).forEach(<span class="fstat-no" title="function not covered" >function(key) {</span></span>
<span class="cstat-no" title="statement not covered" >                currentVal = serviceInstance[key];</span>
<span class="cstat-no" title="statement not covered" >                key = service.namespace + key;</span>
                // if the value is defined, save it to LS, otherwise 
                // remove it from LS
<span class="cstat-no" title="statement not covered" >                if (typeof currentVal !== 'undefined') {</span>
<span class="cstat-no" title="statement not covered" >                    currentValStr = JSON.stringify(currentVal);</span>
<span class="cstat-no" title="statement not covered" >                    $window.localStorage.setItem(key, currentValStr);</span>
                } else {
<span class="cstat-no" title="statement not covered" >                    $window.localStorage.removeItem(key); </span>
                }
            });
        },
&nbsp;
        /**
         * Recovers the service state
         * @param {String} keyName key used for mapping items to the service
         **/
        recoverState: function(keyName) {
            var serviceInstance = service.mapping[keyName].instance;
            var recoveredVal;
            var recoveredValStr;
            var data = service.mapping[keyName].data;
            var fullKey;
            Object.keys(data).forEach(function(key) {
                fullKey = service.namespace + key;
                // if value is defined in the persitence layer, save it to the
                // service instance, otherwise save the default value present
                // in the data property of the registry
                recoveredValStr = $window.localStorage.getItem(fullKey);
                <span class="missing-if-branch" title="if path not taken" >I</span>if (recoveredValStr) {
<span class="cstat-no" title="statement not covered" >                    recoveredVal = JSON.parse(recoveredValStr);</span>
<span class="cstat-no" title="statement not covered" >                    recoverValue(serviceInstance[key], recoveredVal, keyName, key);</span>
                } else {
                    recoverValue(serviceInstance[key], service.mapping[keyName].data[key], keyName, key);
                }
            }); 
        },
&nbsp;
        /**
         * Resets the service state
         * @param {String} keyName key used for mapping itms to the service
         **/
        resetState: <span class="fstat-no" title="function not covered" >function(keyName) {</span>
<span class="cstat-no" title="statement not covered" >            var serviceInstance = service.mapping[keyName].instance;</span>
<span class="cstat-no" title="statement not covered" >            var data = service.mapping[keyName].data;</span>
<span class="cstat-no" title="statement not covered" >            var fullKey;</span>
<span class="cstat-no" title="statement not covered" >           Object.keys(data).forEach(<span class="fstat-no" title="function not covered" >function(key) {</span></span>
<span class="cstat-no" title="statement not covered" >                fullKey = service.namespace + key;</span>
                // remove the value from the persistence layer and set to the default one
<span class="cstat-no" title="statement not covered" >                $window.localStorage.removeItem(fullKey);</span>
<span class="cstat-no" title="statement not covered" >                serviceInstance[key] = service.mapping[keyName].data[key];</span>
           }); 
        }
    };
&nbsp;
    /**
     * Recovers a value back to the serve instance
     * @param {Object} serviceObjectValue object from service instance (to be updated)
     * @param {Object|String|Number} recoveredVal value recovered from persistence layer
     * @param {String} keyName name registered by service (used in mapping)
     * @param {String} key     field name
     **/
    function recoverValue(serviceObjectValue, recoveredVal, keyName, key) {
        // if the recoveredVal is the same as the destination object 
        // when the default value for recovering is the services's self initial property
        // value, don't copy or assign, just return
        if (serviceObjectValue === recoveredVal) {
            return;
        }
        <span class="missing-if-branch" title="else path not taken" >E</span>if (typeof serviceObjectValue === 'object') {
            angular.copy(recoveredVal, serviceObjectValue);
        } else {
<span class="cstat-no" title="statement not covered" >            service.mapping[keyName].instance[key] = recoveredVal;</span>
        }
    }
&nbsp;
    /**
     * Save the object passed to the register method, saving it to the data property on the
     * service mapping
     * @param {String} keyName name registered by service
     * @param {Object} obj     object passed to the register method, specifying default value and
     * expiration time
     **/
    function handleObject(keyName, obj) {
        Object.keys(obj).forEach(function(key) {
            service.mapping[keyName].data[key] = obj[key];   
        });
    }
&nbsp;
    /**
     * Save the string passed to the register method, saving it to the data property on the
     * service mapping
     * Note: This function is needed because even if it does not add new info to the default
     * data set, it adds a new key, which is more semantic and facilitates work afterwards.
     * @param {String} keyName name registered by service
     * @param {String} fieldName property name
     * expiration time
     **/
    function handleString(keyName, fieldName) {
        service.mapping[keyName].data[fieldName] = undefined;   
    }
&nbsp;
    return service;
}]);
&nbsp;
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Mar 10 2015 10:27:58 GMT+0000 (WET)</div>
</div>

<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>

<script src="../sorter.js"></script>
</body>
</html>
