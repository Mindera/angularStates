<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for services/StatesService.js</title>
    <meta charset="utf-8">

    <link rel="stylesheet" href="../prettify.css">

    <link rel="stylesheet" href="../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">services/StatesService.js</span></h1>
    <h2>
        
        Statements: <span class="metric">90.63% <small>(58 / 64)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">75% <small>(21 / 28)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">100% <small>(13 / 13)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">90.32% <small>(56 / 62)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../index.html">All files</a> &#187; <a href="index.html">services/</a> &#187; StatesService.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9</span>
<span class="cline-any cline-yes">17</span>
<span class="cline-any cline-yes">17</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-yes">9</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">17</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict';
&nbsp;
angular.module('angularStates')
.factory('StatesService', ['$window', '$rootElement', function ($window, $rootElement) {
    // TODO: Some stuff to implement in the future:
    // - expiration time for each object saved
    // - adapters so that it supports cookies/indexDB for example
&nbsp;
    var service = {
        namespace: $rootElement.attr('ng-app') ? <span class="branch-0 cbranch-no" title="branch not covered" >$rootElement.attr('ng-app') + '.' </span>: '',
        mapping: {},
&nbsp;
        /**
         * Registers a service instance on the persistence service
         * @param {Object} serviceInstance registered service instance - for updating its state afterwards
         * @param {String} keyName key used for mapping items the each service
         * @param {Array}  fields service properties that should be saved. Note: the elements of this array
         * can be strings (name of the field) or objects (containing default value to use in case of absence
         * in the persistence layer, and expiration time)
         * @throws {Error} will throw if the current keyName is already in use  
         **/
        register: function(serviceInstance, keyName, fields) {
            if (service.mapping[keyName] !== undefined) {
                throw new Error('keyName "' + keyName + '" already in use.'); 
            }
            service.mapping[keyName] = {
                instance: serviceInstance,
                data: {},
                expire: {}
            };
&nbsp;
            fields.map(function(field) {
                var typeOfArgument = typeof field;
                switch (typeOfArgument) {
                    case 'object' : handleObject(keyName, field); break;
                    case 'string' : handleString(keyName, field); break;
<span class="branch-2 cbranch-no" title="branch not covered" >                    default: <span class="cstat-no" title="statement not covered" >break;</span></span>
                }
            });
        },
&nbsp;
        /**
         * Save the service state, based on the values mapped for the keyName provided
         * @param {String} keyName key used for mapping items to the service
         **/
        saveState: function(keyName) {
            var serviceInstance = service.mapping[keyName].instance;
            var currentVal;
            var now = new Date(), then;
            // Save each object for that keyName
            var data = service.mapping[keyName].data;
            Object.keys(data).forEach(function(key) {
                currentVal = serviceInstance[key];
                key = service.namespace + key;
                // if the value is defined, save it to LS, otherwise 
                // remove it from LS
                if (typeof currentVal !== 'undefined') {
                    // Encapsulate value in wrapper object so that we can use json stringify/parse
                    // with confidence
                    var wrapperObj = {
                        value: currentVal
                    };
                    // check if current property has expiration date
                    <span class="missing-if-branch" title="if path not taken" >I</span>if (service.mapping[keyName].expire[key]) {
<span class="cstat-no" title="statement not covered" >                        then = now.getTime();</span>
<span class="cstat-no" title="statement not covered" >                        wrapperObj.expire = then;</span>
                    }
                    wrapperObj = JSON.stringify(wrapperObj); 
                    $window.localStorage.setItem(key, wrapperObj);
                } else {
                    $window.localStorage.removeItem(key); 
                }
            });
        },
&nbsp;
        /**
         * Recovers the service state
         * @param {String} keyName key used for mapping items to the service
         **/
        recoverState: function(keyName) {
            var serviceInstance = service.mapping[keyName].instance;
            var recoveredVal;
            var data = service.mapping[keyName].data;
            var now = new Date();
            var fullKey;
            Object.keys(data).forEach(function(key) {
                fullKey = service.namespace + key;
                // if value is defined in the persitence layer, save it to the
                // service instance, otherwise save the default value present
                // in the data property of the registry
                recoveredVal  = $window.localStorage.getItem(fullKey);
                if (recoveredVal) {
                    // unwrap value
                    recoveredVal = JSON.parse(recoveredVal);
                    <span class="missing-if-branch" title="else path not taken" >E</span>if (!recoveredVal.expire || <span class="branch-1 cbranch-no" title="branch not covered" >recoveredVal.expire &gt; now)</span> {
                        recoverValue(serviceInstance[key], recoveredVal.value , keyName, key);
                    } else {
<span class="cstat-no" title="statement not covered" >                        recoverValue(serviceInstance[key], service.mapping[keyName].data[key], keyName, key);</span>
                    }
                } else {
                    recoverValue(serviceInstance[key], service.mapping[keyName].data[key], keyName, key);
                }
            }); 
        },
&nbsp;
        /**
         * Resets the service state and clears the storage of that service
         * @param {String} keyName key used for mapping items to the service
         **/
        resetState: function(keyName) {
            service.recoverState(keyName);
            service.clearStorage(keyName);
        },
&nbsp;
        /**
         * Clears the service state on the persistence layer
         * @param {String} keyName key used for mapping items to the service
         **/
        clearStorage: function(keyName) {
            var data = service.mapping[keyName].data;
            var fullKey;
           Object.keys(data).forEach(function(key) {
                fullKey = service.namespace + key;
                // remove the value from the persistence layer and set to the default one
                $window.localStorage.removeItem(fullKey);
           }); 
        }
    };
&nbsp;
    /**
     * Recovers a value back to the service instance
     * @param {Object} serviceObjectValue object from service instance (to be updated)
     * @param {Object|String|Number} recoveredVal value recovered from persistence layer
     * @param {String} keyName name registered by service (used in mapping)
     * @param {String} key     field name
     **/
    function recoverValue(serviceObjectValue, recoveredVal, keyName, key) {
        // if the recoveredVal is the same as the destination object 
        // when the default value for recovering is the services's self initial property
        // value, don't copy or assign, just return
        if (serviceObjectValue === recoveredVal) {
            return;
        }
        if (typeof serviceObjectValue === 'object' &amp;&amp; recoveredVal &amp;&amp; recoveredVal !== serviceObjectValue) {
            angular.copy(recoveredVal, serviceObjectValue);
        } else {
            service.mapping[keyName].instance[key] = recoveredVal;
        }
    }
&nbsp;
    /**
     * Save the object passed to the register method, saving it to the data property on the
     * service mapping
     * @param {String}     keyName name registered by service
     * @param {Object}     obj        object passed to the register method, specifying default value and
     * @param {String}     obj.name   name of the field
     * @param {*}          obj.value  default value of the field
     * @param {Numbeer}    obj.expire expiration time for the current data
     **/
    function handleObject(keyName, obj) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (obj.value) {
<span class="cstat-no" title="statement not covered" >            service.mapping[keyName].data[obj.name] = obj.value;</span>
        } else {
            handleString(keyName, obj.name);
        }
        <span class="missing-if-branch" title="if path not taken" >I</span>if (obj.expire) {
<span class="cstat-no" title="statement not covered" >            service.mapping[keyName].expire[obj.name] = obj.expire;</span>
        }
    }
&nbsp;
    /**
     * Save the string passed to the register method, saving it to the data property on the
     * service mapping
     * Note: This function is needed because even if it does not add new info to the default
     * data set, it adds a new key, which is more semantic and facilitates work afterwards.
     * @param {String} keyName name registered by service
     * @param {String} fieldName property name
     * expiration time
     **/
    function handleString(keyName, fieldName) {
        service.mapping[keyName].data[fieldName] = undefined;   
    }
&nbsp;
    return service;
}]);
&nbsp;
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Apr 27 2015 11:14:18 GMT+0100 (WEST)</div>
</div>

<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>

<script src="../sorter.js"></script>
</body>
</html>
